



# 文件服务




## **第一章** 基本概念



在业务场景中会经常涉及到和文件的交互，需要对文件资源进行有效的管理。但传统的单机文件系统在互联网应用场景下往往效率不高、稳定性不佳、扩展困难，无法达到高并发、高性能的业务需求，所以需要有一种高效稳定的方式来提供文件资源管理。

iuap的iuap-saas-filesystem-service服务适配了三种文件系统：阿里云的对象存储服务(OSS)，FastDFS和本地文件存储。

1. FastDFS(Fast Distributed File System)是一个开源的轻量级分布式文件系统，它对文件进行管理，功能包括：文件存储、文件同步、文件访问（文件上传、文件下载）等，解决了大容量存储和负载均衡的问题。特别适合以文件为载体的在线服务，如相册网站、视频网站等等。FastDFS可以高效存储海量文件，通过集群模式水平扩展容量和数据冗余存储。
2. 阿里云对象存储服务（Object Storage Service，简称 OSS），是阿里云提供的海量、安全、低成本、高可靠的云存储服务。可以通过调用 API，在任何应用、任何时间、任何地点上传和下载数据，也可以通过 Web 控制台对数据进行简单的管理。OSS 适合存放任意类型的文件，适合各种网站、开发企业及开发者使用。使用OSS直接上传文件可以节省带宽流量。
3. 本地文件系统则是直接将文件上传到应用服务器上，一般用于单机环境下开发测试使用，不推荐部署在生产环境和集群环境下。

并且文件服务还提供了对文件资源的通用操作，在对不同的文件系统进行适配时，尽量保持接口参数相同，保证用户使用简便。




## **第二章** 技术架构

   2.1技术架构
![img001](/articles/iuap-develop/10-/iuap-filesystem-service/3.5.5-RELEASE/img/1.png)

iuap文件服务对附件组件进行了一次包装，通过调用文件服务的接口，可以对文件进行上传、删除，下载，查询等一系列的操作。在对文件进行操作时，文件的相关信息会通过管理模块，被记录到数据库中。附件组件对应的文件系统有本地文件系统、FastDFS和阿里云OSS三种，实际操作时，附件组件会根据配置文件的选择相应的文件系统。通过整个文件系统的架构，加强了对文件的管理。


  2.2实现原理
![img001](/articles/iuap-develop/10-/iuap-filesystem-service/3.5.5-RELEASE/img/2.png)


1. 通过服务接口调用文件服务。
2. 文件服务调用附件组件，对文件服务器上的文件进行处理。
3. 附件服务器将相关数据返回给文件服务。
4. 文件处理结果返回到文件服务，并返回文件在服务器上的相关信息。文件在服务器上的相关信息会和文件本身的信息一起存入到数据库中。
5. 将相关数据返回给前端。


  2.3两种应用场景的原理

文件信息往往是与单据信息相关联的，所以文件上传时会有两种业务的场景。一种是先单据后文件；另一种是先文件后单据。

 2.3.1先单据后文件

   在先单据后文件的场景下，我们会先将单据的信息保存到数据库中，也就意味着单据的所有信息都已经生成，在上传文件时，我们只要将单据的相关信息跟随文件一起传给文件服务即可。

 2.3.2先文件后单据

   在先文件后单据的场景下我们会先将文件进行上传，这也就意味着文件上传时单据的信息还没有生成，此时，我们需要前端先生成相关的单据信息，使得文件可以上传，然后在单据进行保存               时，使得单据的相关信息和文件上传时使用的单据信息一致即可。


2.4问题解决

1.集群问题

文件系统配有跨域请求过滤器，如果通过nginx配置集群，在使用文件系统时，请求文件服务的ip是nginx的服务器的ip，和文件服务所在的服务器ip不一致，会存在跨域请求的问题。解决方法是修改web.xml文件，将nginx代理服务器的ip和端口设置为可以信任，添加位置如图：

![img001](/articles/iuap-develop/10-/iuap-filesystem-service/3.5.5-RELEASE/img/3.png)




## **第三章** 功能介绍

  3.1文件上传

iuap的文件服务提供了文件上传功能。与直接通过附件组件上传文件不同，直接调用附件组件进行上传只能把文件传到文件服务器上，不会对文件的信息进行处理，这样就无法对上传的文件进行管理。而iuap文件服务提供的文件上传功能会对上传的文件信息进行处理，并将上传的文件的信息存到数据库中，通过文件在服务器上的id与文件进行关联。

3.2文件删除

iuap的文件服务提供了文件删除功能。与直接通过附件组件删除文件不同，直接调用附件组件会把文件服务器上的文件直接删掉，而iuap文件服务会根据实际情况对文件进行删除处理。因为相同的文件不会重复上传到服务器上，所以在数据库中，可能存在着多条数据对应同一个文件的情况。这时，删除文件的时候只删除数据库中的数据，不删除文件服务器上的文件。当文件只对应一条数据的时候，文件和数据会被一起删除。

3.3文件下载

iuap的文件服务提供文件下载功能，下载下来的文件有流和完整的文件两种形式。下载完整的文件是通过浏览器来完成的，就像Chrome下载文件那样。流形式的文件则是在后端获取文件数据时使用。

3.4文件替换

iuap的文件服务提供了文件替换功能，通过上传新的文件可以替换原有的文件。当原文件对应多条数据的时候，只删除相应的数据并上传新的文件。当原文件只对应一条数据的时候，会把数据和文件一起删除并上传新的文件。

3.5文件复制

iuap的文件服务提供了文件复制功能，可以对源文件进行复制，并在数据库里新增一条数据。

3.6获取文件url地址

iuap的文件服务提供了文件url的功能，通过调用对应的接口，可以获得多个文件在服务器上的url。通过这些url可以直接查看文件的相关内容。


## **第五章** 典型业务场景介绍

  5.1文件上传
   
 5.1.1目标

在新增单据和任务的时候往往会添加附件进行详细说明，或者在报销的时候会上传电子发票，又或者在编辑个人信息的时候回上传头像。文件服务就是完成对这些文件的上传的。

5.1.2实现方式

iuap的文件服务对附件组件进行了包装，在调用附件组件上传文件后会获得文件在服务器上的相关信息，如文件在服务器上的id、url地址等。然后根据前端传过来的参数确定文件本身的信息，比如这个文件从哪个模块传上来的，干什么用的。最后将文件在服务器上的信息和文件本身的信息一起存入数据库中。

5.1.3效果

![img001](/articles/iuap-develop/10-/iuap-filesystem-service/3.5.5-RELEASE/img/8.png)


![img001](/articles/iuap-develop/10-/iuap-filesystem-service/3.5.5-RELEASE/img/9.png)


5.2文件下载
   
 5.2.1目标

提供从文件服务器上下载相关文件的功能，并根据实际情况确定是下载流文件还是完整的文件。

5.2.2实现方式

前端访问文件下载接口并提交要下载文件的相关参数，文件服务根据相关文件在文件服务器上的id从文件服务器上获取文件字节流并返回。如果下载的是完整文件，则会通过浏览器解析文件字节流进行下载。下载文件字节流一般用于后端调用或者用JavaSwing开发的程序。

5.2.3效果

![img001](/articles/iuap-develop/10-/iuap-filesystem-service/3.5.5-RELEASE/img/10.png)


![img001](/articles/iuap-develop/10-/iuap-filesystem-service/3.5.5-RELEASE/img/11.png)


5.3文件删除
   
 5.3.1目标

删除用户上传的相关文件。

5.3.2实现方式

点击删除按钮后会访问文件服务的文件删除接口并将要删除的文件的相关信息传过来。如果该文件关联了多条数据库中的数据，那么只删除数据库中的相关数据，不删除文件服务器上的文件。如果该文件只关联了一条数据，则会将数据库中的数据和文件服务器上的文件一起删除。

5.3.3效果

![img001](/articles/iuap-develop/10-/iuap-filesystem-service/3.5.5-RELEASE/img/12.png)

删除成功后：

![img001](/articles/iuap-develop/10-/iuap-filesystem-service/3.5.5-RELEASE/img/13.png)


